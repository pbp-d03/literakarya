{% extends 'base.html' %}
{% load static %}

{% block meta %}
    <title>Tambah Bacaan Digital</title>
{% endblock meta %}

{% block content %}
<style>
    body {
        text-align: center;
        margin: 10px;
    } .custom-select {
        height: auto;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    } #selectedBook {
        display: none;
    }
</style>

<body>
    <h4 class="mt-2 mb-2">Hai Admin LiteraKarya!</h4>
    <label class="mb-2">Berikut ini adalah daftar buku yang harus kamu periksa hari ini.</label>

    <div class="container mt-4">
        <div class="row row-cols-1 row-cols-md-3" id="ereadings-display">
            <!-- Data setiap ereading akan ditunjukkan di bagian ini. -->
        </div>
    </div>
</body>

<script>
    async function getEreadings() {
        return fetch("{% url 'ereading:get_json' %}").then((res) => res.json());
    }

    async function refreshEreadings() {
        let ereadings = await getEreadings();
        let htmlString = ``;

        ereadings.forEach((ereading) => {
            let dateObject = new Date(ereading.fields.last_updated);
            let formattedDate = dateObject.toLocaleDateString(); 
            let formattedTime = dateObject.toLocaleTimeString();

            if (ereading.fields.state == 0) {
                htmlString += `
                    <div class="col mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center" style="background-color: thistle}">
                                <span><strong>Added by:</strong> ${ereading.fields.created_by}</span>
                            </div>
        
                            <div class="card-body text-center" style="background-color: lavenderblush}">   
                                <p class="card-text"><strong>Title: </strong>${ereading.fields.title}</p> 
                                <p class="card-text"><strong>Author: </strong>${ereading.fields.author}</p>
                                <p class="card-text"><strong>Desc: </strong>${ereading.fields.description}</p>
                                <p class="card-text"><strong>Link: </strong><a href="${ereading.fields.link}" target="_blank">${ereading.fields.link}</a></p>
                            </div>

                            <div class="mb-2" aria-label="Item Actions">
                                <button class="btn btn-success btn-sm" onclick="acceptEreading(${ereading.pk})">Accept</button>
                                <button class="btn btn-danger btn-sm" onclick="rejectEreading(${ereading.pk})">Reject</button>
                            </div>

                            <div class="card-footer text-center">
                                <small class="text-muted">Last Updated: </strong>${formattedDate} | ${formattedTime}</small>
                            </div>
                        </div>
                    </div>
                `;
            
            } 
        });
        document.getElementById("ereadings-display").innerHTML = htmlString;
    }
    refreshEreadings();

    async function acceptEreading(id) {
        let form = new FormData();
        form.append("id", id);

        await fetch("{% url 'ereading:accept_ereading' %}", {
            method: "POST",
            body: form,
        }).then(refreshEreadings);
    }

    async function rejectEreading(id) {
        let form = new FormData();
        form.append("id", id);

        await fetch("{% url 'ereading:reject_ereading' %}", {
            method: "POST",
            body: form,
        }).then(refreshEreadings);
    }

    async function deleteEreading(id) {
        let form = new FormData();
        form.append("id", id);

        await fetch("{% url 'ereading:delete_ereading' %}", {
            method: "POST",
            body: form,
        }).then(refreshEreadings);
    }
</script>
{% endblock content %}